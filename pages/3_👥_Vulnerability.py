"""
Population Vulnerability Analysis Page
Displays elderly population and social vulnerability indicators
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from pathlib import Path
import sys

# Add parent directory to path
sys.path.append(str(Path(__file__).parent.parent))
from config import PROCESSED_DATA_DIR

# Page config
st.set_page_config(page_title="Population Vulnerability", page_icon="ğŸ‘¥", layout="wide")

st.title("ğŸ‘¥ Population Vulnerability Analysis")
st.markdown("Analyze demographic vulnerability to heat stress")

# Load vulnerability data
@st.cache_data
def load_vulnerability_data():
    """Load Paris arrondissement vulnerability data"""
    vuln_file = PROCESSED_DATA_DIR / "paris_vulnerability.csv"
    if vuln_file.exists():
        return pd.read_csv(vuln_file)
    return None

vuln_data = load_vulnerability_data()

if vuln_data is not None:
    st.success(f"âœ… Loaded data for {len(vuln_data)} Paris arrondissements")
    
    # Overview metrics
    st.subheader("ğŸ“Š Vulnerability Overview")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "Total Population",
            f"{vuln_data['pop_total'].sum():,.0f}",
            help="Total population across all arrondissements"
        )
    
    with col2:
        st.metric(
            "Population 65+",
            f"{vuln_data['pop_65plus'].sum():,.0f}",
            help="Total elderly population"
        )
    
    with col3:
        avg_pct = vuln_data['pct_65plus'].mean()
        st.metric(
            "Avg % Elderly",
            f"{avg_pct:.1f}%",
            help="Average percentage of population aged 65+"
        )
    
    with col4:
        avg_vuln = vuln_data['vulnerability_score'].mean()
        st.metric(
            "Avg Vulnerability",
            f"{avg_vuln:.1f}/10",
            help="Average vulnerability score"
        )
    
    st.markdown("---")
    
    # Tabs
    tab1, tab2, tab3 = st.tabs(["ğŸ—ºï¸ By Arrondissement", "ğŸ“Š Analysis", "ğŸ” Rankings"])
    
    # TAB 1: By Arrondissement
    with tab1:
        st.subheader("Vulnerability by Arrondissement")
        
        # Bar chart
        fig_bar = px.bar(
            vuln_data.sort_values('pct_65plus', ascending=False),
            x='CODGEO',
            y='pct_65plus',
            title='Percentage of Population 65+ by Arrondissement',
            labels={'CODGEO': 'Arrondissement', 'pct_65plus': '% Population 65+'},
            color='pct_65plus',
            color_continuous_scale='Blues',
            hover_data=['pop_total', 'pop_65plus']
        )
        fig_bar.update_layout(showlegend=False, xaxis_tickangle=-45)
        st.plotly_chart(fig_bar, use_container_width=True)
        
        # Data table
        st.markdown("**Detailed Data:**")
        display_data = vuln_data[['CODGEO', 'pop_total', 'pop_65plus', 'pct_65plus', 'vulnerability_score']].copy()
        display_data.columns = ['Arrondissement', 'Total Pop', 'Pop 65+', '% 65+', 'Vulnerability Score']
        display_data = display_data.sort_values('% 65+', ascending=False)
        
        st.dataframe(
            display_data.style.background_gradient(subset=['% 65+'], cmap='Blues'),
            use_container_width=True
        )
    
    # TAB 2: Analysis
    with tab2:
        st.subheader("ğŸ“ˆ Vulnerability Analysis")
        
        col1, col2 = st.columns(2)
        
        with col1:
            # Distribution histogram
            fig_hist = px.histogram(
                vuln_data,
                x='pct_65plus',
                nbins=10,
                title='Distribution of Elderly Population %',
                labels={'pct_65plus': '% Population 65+', 'count': 'Number of Arrondissements'},
                color_discrete_sequence=['#4472C4']
            )
            st.plotly_chart(fig_hist, use_container_width=True)
            
            # Statistics
            st.markdown("**Statistical Summary:**")
            st.dataframe({
                'Metric': ['Mean', 'Median', 'Std Dev', 'Min', 'Max'],
                '% Elderly': [
                    f"{vuln_data['pct_65plus'].mean():.2f}%",
                    f"{vuln_data['pct_65plus'].median():.2f}%",
                    f"{vuln_data['pct_65plus'].std():.2f}%",
                    f"{vuln_data['pct_65plus'].min():.2f}%",
                    f"{vuln_data['pct_65plus'].max():.2f}%"
                ]
            }, hide_index=True)
        
        with col2:
            # Vulnerability scores
            fig_vuln = px.bar(
                vuln_data.sort_values('vulnerability_score', ascending=False),
                x='CODGEO',
                y='vulnerability_score',
                title='Vulnerability Score by Arrondissement',
                labels={'CODGEO': 'Arrondissement', 'vulnerability_score': 'Vulnerability Score (0-10)'},
                color='vulnerability_score',
                color_continuous_scale='Reds'
            )
            fig_vuln.update_layout(showlegend=False, xaxis_tickangle=-45)
            st.plotly_chart(fig_vuln, use_container_width=True)
            
            # Vulnerability categories
            st.markdown("**Vulnerability Categories:**")
            high_vuln = len(vuln_data[vuln_data['vulnerability_score'] >= 8])
            mod_vuln = len(vuln_data[(vuln_data['vulnerability_score'] >= 6) & (vuln_data['vulnerability_score'] < 8)])
            low_vuln = len(vuln_data[vuln_data['vulnerability_score'] < 6])
            
            st.dataframe({
                'Category': ['ğŸ”´ High (8-10)', 'ğŸŸ¡ Moderate (6-7)', 'ğŸŸ¢ Low (0-5)'],
                'Count': [high_vuln, mod_vuln, low_vuln],
                'Percentage': [
                    f"{high_vuln/len(vuln_data)*100:.1f}%",
                    f"{mod_vuln/len(vuln_data)*100:.1f}%",
                    f"{low_vuln/len(vuln_data)*100:.1f}%"
                ]
            }, hide_index=True)
        
        # Scatter plot: population vs vulnerability
        st.markdown("---")
        fig_scatter = px.scatter(
            vuln_data,
            x='pop_total',
            y='pct_65plus',
            size='pop_65plus',
            text='CODGEO',
            title='Population Size vs Elderly Percentage',
            labels={
                'pop_total': 'Total Population',
                'pct_65plus': '% Population 65+',
                'pop_65plus': 'Elderly Pop'
            },
            color='vulnerability_score',
            color_continuous_scale='RdYlGn_r'
        )
        fig_scatter.update_traces(textposition='top center')
        st.plotly_chart(fig_scatter, use_container_width=True)
    
    # TAB 3: Rankings
    with tab3:
        st.subheader("ğŸ” Arrondissement Rankings")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("### Most Vulnerable")
            st.markdown("*(Highest % elderly population)*")
            
            top_5 = vuln_data.nlargest(5, 'pct_65plus')[['CODGEO', 'pct_65plus', 'pop_65plus', 'vulnerability_score']]
            top_5.columns = ['Arrondissement', '% 65+', 'Pop 65+', 'Vuln Score']
            
            for idx, row in top_5.iterrows():
                st.info(f"""
                **{row['Arrondissement']}**
                - Elderly: {row['% 65+']:.2f}%
                - Population 65+: {row['Pop 65+']:,.0f}
                - Vulnerability: {row['Vuln Score']}/10
                """)
        
        with col2:
            st.markdown("### Least Vulnerable")
            st.markdown("*(Lowest % elderly population)*")
            
            bottom_5 = vuln_data.nsmallest(5, 'pct_65plus')[['CODGEO', 'pct_65plus', 'pop_65plus', 'vulnerability_score']]
            bottom_5.columns = ['Arrondissement', '% 65+', 'Pop 65+', 'Vuln Score']
            
            for idx, row in bottom_5.iterrows():
                st.success(f"""
                **{row['Arrondissement']}**
                - Elderly: {row['% 65+']:.2f}%
                - Population 65+: {row['Pop 65+']:,.0f}
                - Vulnerability: {row['Vuln Score']}/10
                """)
        
        st.markdown("---")
        
        # Key insights
        st.markdown("### ğŸ’¡ Key Insights")
        
        most_vuln = vuln_data.loc[vuln_data['pct_65plus'].idxmax()]
        least_vuln = vuln_data.loc[vuln_data['pct_65plus'].idxmin()]
        
        st.warning(f"""
        **Highest Vulnerability**: {most_vuln['CODGEO']} with {most_vuln['pct_65plus']:.1f}% elderly population
        - This arrondissement may need priority attention during heat waves
        - Consider targeted cooling centers and outreach programs
        """)
        
        st.info(f"""
        **Lowest Vulnerability**: {least_vuln['CODGEO']} with {least_vuln['pct_65plus']:.1f}% elderly population
        - Younger demographic profile
        - Different heat adaptation strategies may be appropriate
        """)
        
        st.markdown("""
        **Paris Context**: The average elderly population across Paris is {:.1f}%, which is slightly below 
        the French national average of ~20%. However, there is significant variation between arrondissements,
        suggesting the need for differentiated heat adaptation strategies.
        """.format(vuln_data['pct_65plus'].mean()))

else:
    st.error("âŒ Vulnerability data not found!")
    st.info("""
    Please run the population analysis notebook first:
    1. Open `notebooks/02_population_data.ipynb`
    2. Run all cells to generate the vulnerability data
    3. Refresh this page
    """)

# Sidebar
with st.sidebar:
    st.markdown("---")
    st.markdown("### ğŸ“– About Vulnerability")
    st.info("""
    **Why age 65+?**
    
    Elderly populations are more vulnerable to heat stress due to:
    - Reduced thermoregulation
    - Chronic health conditions
    - Social isolation
    - Limited mobility
    
    **Vulnerability Scoring:**
    - 0-2: Very low (<10% elderly)
    - 3-4: Low (10-15%)
    - 5-6: Moderate (15-20%)
    - 7-8: High (20-25%)
    - 9-10: Very high (>25%)
    """)